blueprint:
  name: View Assist - Alarms Reminders Timers WORK IN PROGRESS
  description:
    Ask Assist to set an alarm, reminder, or timer  (View Assist alarmsreminderstimers
    v 1.3.0-beta5)
  domain: automation
  input:
    spokenlanguage:
      name: Language
      description: The desired spoken language
      default: en
      selector:
        language:
          languages:
            - en
          native_name: false
          no_sort: false
    alarmsound_path:
      name: Alarm Sound Path
      description:
        The path to the sound file that will sound repeatedly when the
        timer expires
      default: /view_assist/views/alarm/sounds_timer_finished.wav
    use_vaca_onboard_sound:
      name: Use VACA onboard sound
      description: If enabled, the View Assist Companion App (VACA) satellite will use the onboard sound rather than the sound in the option above.  All others will use the specified sound.
      default: false
      selector:
        boolean: {}
    snooze_time:
      name: Snooze Time
      description:
        The amount of time in minutes to wait after hitting snooze button
        before sounding alarm again
      default: "10"
    view:
      name: View
      description:
        The View Assist dashboard view to use for displaying the notification
        and buttons to dismiss/snooze
      default: /view-assist/alarm
    allow_hold_mode:
      name: Allow Hold Mode
      description: If enabled, the display will stay (hold) on the timer view until dismissed.
      default: false
      selector:
        boolean: {}
    enabled_icons:
      name: Enabled Status Icons
      description: "Select which features should display status icons on your devices."
      default:
        - timers
        - alarms
        - reminders
      selector:
        select:
          multiple: true
          options:
            - label: "Timers"
              value: "timers"
            - label: "Alarms"
              value: "alarms"
            - label: "Reminders"
              value: "reminders"
    trigger_sentences_section:
      name: "Trigger Sentence Configuration"
      icon: mdi:form-select
      description: "Modify these sentences to match your language or preferences"
      collapsed: true
      input:
        timer:
          name: Set Timer
          description: "Sentences to create a new timer."
          default:
            - "set [a] timer for {when}"
            - "set [a] {when} timer"
            - "(set|start) [a | an] {name} timer for {when}"
          selector:
            object: {}
        reminder:
          name: Set Reminder
          description: "Sentences to create a new reminder."
          default:
            - "(remind me | set a reminder) to {name} (at | in) {when}"
            - "remind me (at | in) {when} to {name}"
            - "set a reminder (at | for) {when} to {name}"
            - "set a reminder for {when}"
          selector:
            object: {}
        alarm:
          name: Set Alarm
          description: "Sentences to create a new alarm."
          default:
            - "set [an] alarm for {when}"
            - "set a {name} alarm for {when}"
          selector:
            object: {}
        listtimers:
          name: List Timers
          description: "Sentences specifically for listing active timers/alarms."
          default:
            - "list [me] my (timers | alarms | reminders)"
          selector:
            object: {}
        showtimers:
          name: Show Timers
          description: "Sentences specifically for showing active timers/alarms on a display."
          default:
            - "show [me] my (timers | alarms | reminders)"
          selector:
            object: {}
        snoozealarm:
          name: Snooze Alarm
          description: "Sentences to snooze a ringing alarm."
          default:
            - "snooze [my] (alarm | timer | reminder)"
          selector:
            object: {}
        timeremaining:
          name: Time Remaining
          description: "Sentences to check how much time is left."
          default:
            - "how much time [is] left on my (alarm | timer | reminder)"
            - "how much time [is] left on my {name} (alarm | timer | reminder)"
            - "how (long | long's) [is] left on my (alarm | timer | reminder)"
            - "how (long | long's) [is] left on my {name} (alarm | timer | reminder)"
          selector:
            object: {}
        canceltimer:
          name: Cancel Timer
          description: "Sentences to stop or cancel a timer/alarm."
          default:
            - "cancel my {name} (alarm | timer | reminder)"
            - "cancel my (alarm | timer | reminder) for {when}"
            - "(Turn off | cancel | stop) [my] (alarm | timer | reminder)"
          selector:
            object: {}
trigger:
  - platform: conversation
    command: !input timer
    id: timer
  - platform: conversation
    command: !input reminder
    id: reminder
  - platform: conversation
    command: !input alarm
    id: alarm
  - platform: conversation
    command: !input listtimers
    id: listtimers
  - platform: conversation
    command: !input showtimers
    id: showtimers
  - platform: conversation
    command: !input snoozealarm
    id: snoozealarm
  - platform: conversation
    command: !input timeremaining
    id: timeremaining
  - platform: conversation
    command: !input canceltimer
    id: canceltimer
  - event_type: va_timer_warning
    id: timerwarning
    trigger: event
    alias: When viewassist event warning expired fires
  - event_type: va_timer_expired
    id: ringalarm
    trigger: event
    alias: When viewassist event timer expired fires
  - alias: When SNOOZE button pressed
    event_type: viewassist
    trigger: event
    id: snoozealarm
    enabled: true
    event_data:
      command: snooze alarm
  - alias: When DISMISS button pressed
    event_type: viewassist
    trigger: event
    id: dismissalarm
    enabled: true
    event_data:
      command: dismiss alarm
  - alias: When VA cancel_timer runs
    trigger: event
    id: cancel_timer_trigger
    event_type: call_service
    event_data:
      domain: view_assist
      service: cancel_timer
  - alias: When VA set_timer runs
    trigger: event
    id: set_timer_trigger
    event_type: call_service
    event_data:
      domain: view_assist
      service: set_timer
condition: []
action:
  - variables:
      target_satellite_device:
        "{{ view_assist_entity(trigger.device_id) if trigger.platform
        == 'conversation' else trigger.event.data.entity_id }}"
      target_mediaplayer_device: "{{ state_attr(target_satellite_device, 'mediaplayer_device')}}"
      target_satellite_device_type: "{{ state_attr(target_satellite_device, 'type')}}"
      spokenlanguage: !input spokenlanguage
      alarmsound_path: !input alarmsound_path
      view: !input view
      snooze_time_input: !input snooze_time
      snooze_time: "{{ snooze_time_input | int }}"
      allow_hold_mode: !input allow_hold_mode
      use_vaca_onboard_sound: !input use_vaca_onboard_sound
      enabled_icons: !input enabled_icons
      is_vaca_device: >-
        {% set mic_ent = state_attr(target_satellite_device, 'mic_device') %}
        {% set dev_id = device_id(mic_ent) if mic_ent else none %}
        {{ 'vaca' in (device_attr(dev_id, 'identifiers') | string) if dev_id else false }}
      trigger_vaca_onboard: "{{ use_vaca_onboard_sound and is_vaca_device }}"
      vaca_alarm_switch: >-
        {% set mic_ent = state_attr(target_satellite_device, 'mic_device') %}
        {{ device_entities(device_id(mic_ent)) | select('match', '^switch\..*_alarm$') | first | default('') if mic_ent else '' }}
      translations:
        en:
          responses:
            no_active_timers: "There are no active timers."
            one_active_timer: "There is one active timer:"
            multiple_active_timers: "There are {count} active timers:"
            final_timer: "and {timer_expiry_speak}"
            no_display: "This device does not have a display to show timers"
            timer_cancel: "Your {timer_info} has been canceled"
            named_timer_not_found: "That timer could not be found"
            timer_not_found: "The {timer_info} could not be found"
            time_left: "You have {time_left} on your {timer_info}"
  - choose:
      - conditions:
          - condition: trigger
            id:
              - timer
              - alarm
              - reminder
        sequence:
          - variables:
              device_id: "{{ trigger.device_id }}"
              type: "{{ trigger.id }}"
              time: "{{ trigger.slots.when }}"
              name: '{{ trigger.slots.name if trigger.slots.name is defined else "" }}'
              language: "{{ trigger.user_input.language }}"
          - action: view_assist.set_timer
            metadata: {}
            data:
              device_id: "{{ device_id }}"
              type: "{{ type }}"
              time: "{{ time }}"
              name: "{{ name }}"
              language: "{{ language }}"
            response_variable: timer_result
          - set_conversation_response: "{{ timer_result.response }}"
          - if:
              - condition: template
                value_template:
                  "{{ timer_result.timer is defined and timer_result.timer !=
                  null and target_satellite_device_type != 'audio_only'}}"
            then:
              - action: view_assist.navigate
                data:
                  device: "{{ target_satellite_device }}"
                  path: "{{ view }}"
          - if:
              - condition: template
                value_template: "{{ allow_hold_mode and type == 'timer'}}"
            then:
              - action: view_assist.set_state
                target:
                  entity_id: "{{ target_satellite_device }}"
                data:
                  mode: hold
      - conditions:
          - condition: trigger
            id:
              - timerwarning
              - ringalarm
        sequence:
          - action: view_assist.navigate
            data:
              device: "{{ target_satellite_device }}"
              path: "{{ view }}"
          - action: view_assist.set_state
            target:
              entity_id: "{{ target_satellite_device }}"
            data:
              mode: hold
          - if:
              - condition: template
                value_template:
                  "{% if trigger.id == 'ringalarm' %}true{% else %}false{%
                  endif %}"
            then:
              - if:
                  - condition: template
                    value_template: >-
                      {{ trigger_vaca_onboard }}
                then:
                  - action: switch.turn_on
                    target:
                      entity_id: "{{ vaca_alarm_switch }}"
                else:
                  - action: view_assist.sound_alarm
                    data:
                      entity_id: "{{ target_mediaplayer_device }}"
                      media_file: "{{ alarmsound_path }}"

      - conditions:
          - condition: trigger
            id:
              - dismissalarm
        sequence:
          - variables:
              timer_id: "{{ trigger.event.data.timer_id }}"

          - if:
              - condition: template
                value_template: >-
                  {{ trigger_vaca_onboard }}
            then:
              - action: switch.turn_off
                target:
                  entity_id: "{{ vaca_alarm_switch }}"
            else:
              - action: view_assist.cancel_sound_alarm
                data:
                  entity_id: "{{ target_mediaplayer_device }}"
          - action: view_assist.cancel_timer
            data:
              timer_id: "{{ timer_id }}"
          - delay: "00:00:01"
          - action: view_assist.get_timers
            data: {}
            response_variable: timer_data
          - variables:
              timer_count: "{{ timer_data.get('result', []) | selectattr('timer_class', 'eq', 'timer') | list | count }}"
          - if:
              - condition: template
                value_template: "{{ (timer_count > 0 and not allow_hold_mode) or (timer_count == 0) }}"
            then:
              - action: view_assist.set_state
                target:
                  entity_id: "{{ target_satellite_device }}"
                data:
                  mode: normal
      - conditions:
          - condition: trigger
            id:
              - snoozealarm
        sequence:
          - variables:
              new_time: "{{ snooze_time }} minutes"
              timer_id: "{{ trigger.event.data.timer_id }}"
          - if:
              - condition: template
                value_template: >-
                  {{ trigger_vaca_onboard }}
            then:
              - action: switch.turn_off
                target:
                  entity_id: "{{ vaca_alarm_switch }}"
            else:
              - action: view_assist.cancel_sound_alarm
                data:
                  entity_id: "{{ target_mediaplayer_device }}"
          - action: view_assist.snooze_timer
            data:
              timer_id: "{{ timer_id }}"
              time: "{{ new_time }}"
            response_variable: snooze_response
          - action: view_assist.set_state
            target:
              entity_id: "{{ target_satellite_device }}"
            data:
              mode: normal
          - set_conversation_response: "{{ snooze_response.response }}"
      - conditions:
          - condition: trigger
            id:
              - canceltimer
        sequence:
          - action: view_assist.get_timers
            data:
              device_id: "{{ trigger.device_id }}"
              name:
                '{{ trigger.slots.name if trigger.slots.name is defined else trigger.slots.when
                if trigger.slots.when is defined else "" }}'
              include_expired: true
            response_variable: timer_info
          - variables:
              timer_id:
                '{{ timer_info["result"][0].id if timer_info["result"] | length
                > 0 else "" }}'
              timer_class:
                '{{ timer_info["result"][0].timer_class if timer_info["result"]
                | length > 0 else "" }}'
              timer_name:
                '{{ timer_info["result"][0].name if timer_info["result"] | length
                > 0 else "" }}'
              timer_sentence:
                '{{ timer_info["result"][0].extra_info.sentence if timer_info["result"]
                | length > 0 else "" }}'
          - if:
              - condition: template
                value_template: '{% if timer_id != "" %}true{% endif %}'
            then:
              - action: view_assist.cancel_sound_alarm
                data:
                  entity_id: "{{ target_mediaplayer_device }}"
              - action: view_assist.cancel_timer
                data:
                  timer_id: "{{ timer_id }}"
              - set_conversation_response: >
                  {{ translations[spokenlanguage]['responses']['timer_cancel'].replace('{timer_info}', (timer_name if timer_name else timer_sentence) ~ ' ' ~ timer_class) }}
              - if:
                  - condition: template
                    value_template: "{{ allow_hold_mode and type == 'timer'}}"
                then:
                  - action: view_assist.set_state
                    target:
                      entity_id: "{{ target_satellite_device }}"
                    data:
                      mode: normal
            else:
              - set_conversation_response: >
                  {{ translations[spokenlanguage]['responses']['named_timer_not_found'] }}
              - if:
                  - condition: template
                    value_template:
                      "{% if target_satellite_device_type != 'audio_only' %}true{%
                      else %}false{% endif %}"
                then:
                  - action: view_assist.navigate
                    data:
                      device: "{{ target_satellite_device }}"
                      path: "{{ view }}"
      - conditions:
          - condition: trigger
            id:
              - timeremaining
        sequence:
          - action: view_assist.get_timers
            data:
              device_id: "{{ trigger.device_id }}"
              name: '{{ trigger.slots.name if trigger.slots.name is defined else "" }}'
            response_variable: timer_info
          - variables:
              timer_id:
                '{{ timer_info["result"][0].id if timer_info["result"] | length
                > 0 else "" }}'
              timer_class:
                '{{ timer_info["result"][0].timer_class if timer_info["result"]
                | length > 0 else "" }}'
              timer_name:
                '{{ timer_info["result"][0].name if timer_info["result"] | length
                > 0 else "" }}'
              timer_duration:
                '{{ timer_info["result"][0].duration if timer_info["result"]
                | length > 0 else "" }}'
              time_left:
                '{{ timer_info["result"][0].expiry.text if timer_info["result"]
                | length > 0 else "" }}'
          - if:
              - condition: template
                value_template: "{% if timer_id != '' %}true{% endif %}"
            then:
              - set_conversation_response: >
                  {{ translations[spokenlanguage]['responses']['time_left']
                    .replace('{time_left}', time_left)
                    .replace('{timer_info}', (timer_name if timer_name else timer_duration) ~ ' ' ~ timer_class)
                  }}
              - if:
                  - condition: template
                    value_template:
                      "{% if target_satellite_device_type != 'audio_only' %}true{%
                      else %}false{% endif %}"
                then:
                  - action: view_assist.navigate
                    data:
                      device: "{{ target_satellite_device }}"
                      path: "{{ view }}"
            else:
              - set_conversation_response: >
                  {{ translations[spokenlanguage]['responses']['timer_not_found'].replace('{timer_info}', (timer_name if timer_name else timer_sentence) ~ ' ' ~ timer_class) }}
              - if:
                  - condition: template
                    value_template:
                      "{% if target_satellite_device_type != 'audio_only' %}true{%
                      else %}false{% endif %}"
                then:
                  - action: view_assist.navigate
                    data:
                      device: "{{ target_satellite_device }}"
                      path: "{{ view }}"
      - conditions:
          - condition: trigger
            id:
              - listtimers
        sequence:
          - variables:
              target_satellite_device: "{{ view_assist_entity(trigger.device_id) }}"
              target_satellite_device_type: "{{ state_attr(target_satellite_device, 'type')}}"
              device_id: "{{ trigger.device_id }}"
          - action: view_assist.get_timers
            data:
              device_id: "{{ device_id }}"
            response_variable: timer_info
          - set_conversation_response: >
              {% set active_timers = timer_info['result'] | selectattr('status', '!=', 'expired') | list %}
              {% set count = active_timers | length %}
              {% if count == 0 %}
                {{ translations[spokenlanguage]['responses']['no_active_timers'] }}
              {% else %}
                {% if count == 1 %}
                  {{ translations[spokenlanguage]['responses']['one_active_timer'] }}
                {% else %}
                  {{ translations[spokenlanguage]['responses']['multiple_active_timers'].replace('{count}', count | string) }}
                {% endif %}
                {% for timer in active_timers -%}
                  {% if count > 1 and loop.last -%}
                    {{ translations[spokenlanguage]['responses']['final_timer'].replace('{timer_expiry_speak}', timer['expiry']['speak']) }}
                  {%- else -%}
                    {{ timer['expiry']['speak'] }}{{ ',' if count > 1 else '' }}
                  {%- endif %}
                {%- endfor %}
              {% endif %}
          - if:
              - condition: template
                value_template:
                  "{% if target_satellite_device_type != 'audio_only' %}true{%
                  else %}false{% endif %}"
            then:
              - action: view_assist.navigate
                data:
                  device: "{{ target_satellite_device }}"
                  path: "{{ view }}"
      - conditions:
          - condition: trigger
            id:
              - showtimers
        sequence:
          - if:
              - condition: template
                value_template:
                  "{% if target_satellite_device_type != 'audio_only' %}true{%
                  else %}false{% endif %}"
            then:
              - action: view_assist.navigate
                data:
                  device: "{{ target_satellite_device }}"
                  path: "{{ view }}"
              - set_conversation_response: ""
            else:
              - set_conversation_response: >
                  {{ translations[spokenlanguage]['responses']['no_display'] }}
      - conditions:
          - condition: trigger
            id:
              - cancel_timer_trigger
        sequence:
          - variables:
              timer_id: "{{ trigger.event.data.service_data.timer_id }}"
          - delay: "00:00:01"
          - action: view_assist.get_timers
            data: {}
            response_variable: timer_data
          - variables:
              timer_count: "{{ timer_data.get('result', []) | selectattr('timer_class', 'eq', 'timer') | list | count }}"
              reminder_count: "{{ timer_data.get('result', []) | selectattr('timer_class', 'eq', 'reminder') | list | count }}"
              alarm_count: "{{ timer_data.get('result', []) | selectattr('timer_class', 'eq', 'alarm') | list | count }}"
              all_display_entities: "{{ view_assist_entities(filter={'type':'view_audio'}) }}"
              contains_timer_icon: >
                {% set ns = namespace(found=[]) %}
                {% for e in all_display_entities %}
                  {% set icons = state_attr(e, 'status_icons') %}
                  {% if icons is iterable and 'view:alarm|timer-outline' in icons %}
                    {% set ns.found = ns.found + [e] %}
                  {% endif %}
                {% endfor %}
                {{ ns.found }}
              contains_reminder_icon: >
                {% set ns = namespace(found=[]) %}
                {% for e in all_display_entities %}
                  {% set icons = state_attr(e, 'status_icons') %}
                  {% if icons is iterable and 'view:alarm|reminder' in icons %}
                    {% set ns.found = ns.found + [e] %}
                  {% endif %}
                {% endfor %}
                {{ ns.found }}
              contains_alarm_icon: >
                {% set ns = namespace(found=[]) %}
                {% for e in all_display_entities %}
                  {% set icons = state_attr(e, 'status_icons') %}
                  {% if icons is iterable and 'view:alarm|alarm' in icons %}
                    {% set ns.found = ns.found + [e] %}
                  {% endif %}
                {% endfor %}
                {{ ns.found }}
          - if:
              - condition: template
                value_template: "{{ timer_count == 0 and contains_timer_icon | count > 0 }}"
            then:
              - repeat:
                  for_each: "{{ contains_timer_icon }}"
                  sequence:
                    - action: view_assist.remove_status_item
                      data:
                        entity_id: "{{ repeat.item }}"
                        status_item: "view:alarm|timer-outline"
          - if:
              - condition: template
                value_template: "{{ timer_count == 0 and contains_reminder_icon | count > 0 }}"
            then:
              - repeat:
                  for_each: "{{ contains_reminder_icon }}"
                  sequence:
                    - action: view_assist.remove_status_item
                      data:
                        entity_id: "{{ repeat.item }}"
                        status_item: "view:alarm|reminder"
          - if:
              - condition: template
                value_template: "{{ timer_count == 0 and contains_alarm_icon | count > 0 }}"
            then:
              - repeat:
                  for_each: "{{ contains_alarm_icon }}"
                  sequence:
                    - action: view_assist.remove_status_item
                      data:
                        entity_id: "{{ repeat.item }}"
                        status_item: "view:alarm|alarm"
          # This is broken as we can't figure out what device the timer was set on to change the state
          # - if:
          #     - condition: template
          #       value_template: "{{ timer_count == 0 }}"
          #   then:
          #     - action: view_assist.set_state
          #       target:
          #         entity_id: "{{ target_satellite_device }}"
          #       data:
          #         mode: normal
      - conditions:
          - condition: trigger
            id:
              - set_timer_trigger
        sequence:
          - delay: "00:00:01"
          - action: view_assist.get_timers
            data:
              device_id: "{{ trigger.event.data.service_data.device_id }}"
            response_variable: timer_data
          - variables:
              target_satellite_device: "{{ timer_data['result'][0]['entity_id'] }}"
              timer_count: "{{ timer_data.result | selectattr('timer_class', 'eq', 'timer') | list | count }}"
              reminder_count: "{{ timer_data.result | selectattr('timer_class', 'eq', 'reminder') | list | count }}"
              alarm_count: "{{ timer_data.result | selectattr('timer_class', 'eq', 'alarm') | list | count }}"
          - if:
              - condition: template
                value_template: "{{ 'timers' in enabled_icons and timer_count == 1 }}"
            then:
              - action: view_assist.add_status_item
                data:
                  entity_id: "{{ target_satellite_device }}"
                  status_item: "view:alarm|timer-outline"
          - if:
              - condition: template
                value_template: "{{ 'reminder' in enabled_icons and reminder_count == 1 }}"
            then:
              - action: view_assist.add_status_item
                data:
                  entity_id: "{{ target_satellite_device }}"
                  status_item: "view:alarm|reminder"
          - if:
              - condition: template
                value_template: "{{ 'alarm' in enabled_icons and alarm_count == 1 }}"
            then:
              - action: view_assist.add_status_item
                data:
                  entity_id: "{{ target_satellite_device }}"
                  status_item: "view:alarm|alarm"
mode: parallel
